import React, { useState, useEffect, useRef } from 'react';
import { useSearchParams } from 'react-router-dom';
import { bakingIngredientsList, savoryIngredientsList } from '../../data/ingredients/ingredientsList';
import { useSettings } from '../../hooks/useSettings';

export default function IngredientsPage() {
  const [searchParams] = useSearchParams();
  const { categoryStructure, categories, vendors } = useSettings();
  const [ingredients, setIngredients] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterCategory, setFilterCategory] = useState('');
  const [filterVendor, setFilterVendor] = useState('');
  const [editingId, setEditingId] = useState(null);
  const [editForm, setEditForm] = useState({});
  const [showAddForm, setShowAddForm] = useState(false);
  const [sortColumn, setSortColumn] = useState('name');
  const [sortDirection, setSortDirection] = useState('asc');
  const [selectedItems, setSelectedItems] = useState(new Set());
  const [showImportModal, setShowImportModal] = useState(false);
  const [importData, setImportData] = useState([]);
  const [importMatches, setImportMatches] = useState({});
  const fileInputRef = useRef(null);
  const [newIngredient, setNewIngredient] = useState({
    name: '', category: 'Produce', subcategory: 'Other', unit: 'lb', 
    vendor: 'Sysco', vendorCode: '', packSize: '', casePrice: 0, unitPrice: 0
  });

  const units = ['lb', 'oz', 'g', 'kg', 'ea', 'doz', 'bunch', 'qt', 'gal', 'pt', 'cup', 'can', 'bottle', 'jar', 'bag', 'box', 'case'];

  useEffect(() => {
    loadIngredients();
    const editName = searchParams.get('edit');
    if (editName) setSearchTerm(editName);
  }, [searchParams]);

  const loadIngredients = () => {
    const customIngredients = JSON.parse(localStorage.getItem('customIngredients') || '[]');
    const ingredientEdits = JSON.parse(localStorage.getItem('ingredientEdits') || '{}');
    const today = new Date().toISOString();
    const baseIngredients = [...bakingIngredientsList, ...savoryIngredientsList].map(ing => {
      const edits = ingredientEdits[ing.id] || {};
      return { ...ing, lastUpdated: today, ...edits };
    });
    setIngredients([...baseIngredients, ...customIngredients]);
  };

  const saveCustomIngredients = (customs) => localStorage.setItem('customIngredients', JSON.stringify(customs));

  const saveIngredientEdit = (id, updates) => {
    const timestamp = new Date().toISOString();
    const updatesWithTime = { ...updates, lastUpdated: timestamp };
    
    const customIngredients = JSON.parse(localStorage.getItem('customIngredients') || '[]');
    const isCustom = customIngredients.some(i => i.id === id);
    if (isCustom) {
      const updated = customIngredients.map(i => i.id === id ? { ...i, ...updatesWithTime } : i);
      saveCustomIngredients(updated);
    } else {
      const edits = JSON.parse(localStorage.getItem('ingredientEdits') || '{}');
      edits[id] = { ...edits[id], ...updatesWithTime };
      localStorage.setItem('ingredientEdits', JSON.stringify(edits));
    }
    return timestamp;
  };

  const formatDate = (dateString) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  };

  const handleEdit = (ingredient) => {
    setEditingId(ingredient.id);
    setEditForm({ 
      ...ingredient,
      vendor: ingredient.vendor || 'Sysco',
      vendorCode: ingredient.vendorCode || ingredient.syscoCode || '',
      packSize: ingredient.packSize || ingredient.syscoPackSize || '',
      casePrice: ingredient.casePrice || ingredient.syscoPrice || 0,
      unitPrice: ingredient.unitPrice || 0,
      subcategory: ingredient.subcategory || 'Other',
      programs: ingredient.programs || ['Baking & Pastry Arts', 'Culinary Arts', 'Foodservice']
    });
  };

  const handleSaveEdit = () => {
    const timestamp = saveIngredientEdit(editingId, editForm);
    setIngredients(prev => prev.map(i => i.id === editingId ? { ...i, ...editForm, lastUpdated: timestamp } : i));
    setEditingId(null);
    setEditForm({});
  };

  const handleCancelEdit = () => { setEditingId(null); setEditForm({}); };

  const handleAddIngredient = () => {
    if (!newIngredient.name.trim()) { alert('Please enter an ingredient name'); return; }
    const id = 'CUSTOM-' + Date.now();
    const timestamp = new Date().toISOString();
    const ingredient = { ...newIngredient, id, lastUpdated: timestamp };
    const customIngredients = JSON.parse(localStorage.getItem('customIngredients') || '[]');
    customIngredients.push(ingredient);
    saveCustomIngredients(customIngredients);
    setIngredients(prev => [...prev, ingredient]);
    setNewIngredient({ name: '', category: 'Produce', subcategory: 'Other', unit: 'lb', vendor: 'Sysco', vendorCode: '', packSize: '', casePrice: 0, unitPrice: 0 });
    setShowAddForm(false);
  };

  const handleDeleteIngredient = (id) => {
    if (!window.confirm('Delete this ingredient?')) return;
    const customIngredients = JSON.parse(localStorage.getItem('customIngredients') || '[]');
    const isCustom = customIngredients.some(i => i.id === id);
    if (isCustom) {
      saveCustomIngredients(customIngredients.filter(i => i.id !== id));
      setIngredients(prev => prev.filter(i => i.id !== id));
    } else {
      alert('Cannot delete base ingredients. You can only delete custom ingredients.');
    }
  };

  const exportIngredients = () => {
    let csv = 'Name,Category,Subcategory,Unit,Vendor,Vendor Code,Pack Size,Case Price,Last Updated\n';
    filteredIngredients.forEach(ing => {
      const row = [
        '"' + (ing.name || '').replace(/"/g, '""') + '"',
        '"' + (ing.category || '').replace(/"/g, '""') + '"',
        '"' + (ing.subcategory || 'Other').replace(/"/g, '""') + '"',
        '"' + (ing.unit || '').replace(/"/g, '""') + '"',
        '"' + (ing.vendor || 'Sysco').replace(/"/g, '""') + '"',
        '"' + (ing.vendorCode || ing.syscoCode || '').replace(/"/g, '""') + '"',
        '"' + (ing.packSize || ing.syscoPackSize || '').replace(/"/g, '""') + '"',
        (ing.casePrice || ing.syscoPrice || 0).toFixed(2),
        '"' + (ing.lastUpdated || '').replace(/"/g, '""') + '"'
      ];
      csv += row.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ingredients-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  };

  // Sysco CSV Import functions
  const handleImportClick = () => {
    fileInputRef.current?.click();
  };

  const parseSyscoCSV = (text) => {
    const lines = text.split('\n');
    const items = [];
    
    for (const line of lines) {
      if (!line.startsWith('"P"')) continue;
      
      // Parse CSV line with quotes
      const matches = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
      if (!matches) continue;
      
      const fields = matches.map(f => f.replace(/^"|"$/g, '').trim());
      
      // Fields: 0=type, 1=SUPC, 7=Pack, 8=Size, 9=Unit, 10=Brand, 11=Mfr#, 12=Desc, 13=Cat, 14=Case$
      const item = {
        syscoCode: fields[1] || '',
        pack: fields[7] || '',
        size: fields[8] || '',
        unit: fields[9] || '',
        brand: fields[10] || '',
        mfrNum: fields[11] || '',
        description: fields[12] || '',
        category: fields[13] || '',
        casePrice: parseFloat(fields[14]) || 0,
        packSize: (fields[7] && fields[8]) ? `${fields[7]}/${fields[8]}` : fields[8] || ''
      };
      
      if (item.syscoCode && item.description) {
        items.push(item);
      }
    }
    
    return items;
  };

  const findBestMatch = (syscoItem) => {
    const desc = syscoItem.description.toLowerCase();
    
    // First try exact Sysco code match
    const codeMatch = ingredients.find(ing => 
      (ing.syscoCode === syscoItem.syscoCode) || (ing.vendorCode === syscoItem.syscoCode)
    );
    if (codeMatch) return { ingredient: codeMatch, confidence: 'exact' };
    
    // Then try name matching
    let bestMatch = null;
    let bestScore = 0;
    
    for (const ing of ingredients) {
      const ingName = ing.name.toLowerCase();
      const words = ingName.split(' ');
      
      let score = 0;
      for (const word of words) {
        if (word.length > 2 && desc.includes(word)) {
          score += word.length;
        }
      }
      
      // Bonus for category match
      if (syscoItem.category === 'Produce' && ing.category === 'Produce') score += 3;
      if (syscoItem.category === 'Dairy' && ing.category === 'Dairy') score += 3;
      if (syscoItem.category === 'Frozen' && ing.category === 'Frozen Foods') score += 3;
      
      if (score > bestScore) {
        bestScore = score;
        bestMatch = ing;
      }
    }
    
    if (bestScore >= 5) {
      return { ingredient: bestMatch, confidence: bestScore >= 8 ? 'high' : 'medium' };
    }
    
    return null;
  };

  const handleFileSelect = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const text = event.target?.result;
      const items = parseSyscoCSV(text);
      setImportData(items);
      
      // Auto-match items
      const matches = {};
      for (const item of items) {
        const match = findBestMatch(item);
        if (match) {
          matches[item.syscoCode] = {
            ingredientId: match.ingredient.id,
            ingredientName: match.ingredient.name,
            confidence: match.confidence
          };
        }
      }
      setImportMatches(matches);
      setShowImportModal(true);
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  const handleImportApply = () => {
    let updateCount = 0;
    const timestamp = new Date().toISOString();
    
    for (const item of importData) {
      const match = importMatches[item.syscoCode];
      if (match && match.ingredientId) {
        saveIngredientEdit(match.ingredientId, {
          vendorCode: item.syscoCode,
          packSize: item.packSize,
          casePrice: item.casePrice,
          vendor: 'Sysco'
        });
        
        setIngredients(prev => prev.map(ing => {
          if (ing.id === match.ingredientId) {
            return {
              ...ing,
              vendorCode: item.syscoCode,
              packSize: item.packSize,
              casePrice: item.casePrice,
              vendor: 'Sysco',
              lastUpdated: timestamp
            };
          }
          return ing;
        }));
        
        updateCount++;
      }
    }
    
    alert(`Updated ${updateCount} ingredients with new Sysco data.`);
    setShowImportModal(false);
    setImportData([]);
    setImportMatches({});
  };

  const toggleSelected = (id) => {
    setSelectedItems(prev => {
      const newSet = new Set(prev);
      newSet.has(id) ? newSet.delete(id) : newSet.add(id);
      return newSet;
    });
  };

  const selectAll = () => setSelectedItems(new Set(filteredIngredients.map(i => i.id)));
  const selectNone = () => setSelectedItems(new Set());
  const selectAllInView = () => selectedItems.size === filteredIngredients.length ? selectNone() : selectAll();

  const bulkUpdateCategory = (category) => {
    if (!category) return;
    const subcategory = categoryStructure[category]?.[0] || 'Other';
    const timestamp = new Date().toISOString();
    Array.from(selectedItems).forEach(id => saveIngredientEdit(id, { category, subcategory }));
    setIngredients(prev => prev.map(ing => selectedItems.has(ing.id) ? { ...ing, category, subcategory, lastUpdated: timestamp } : ing));
    setSelectedItems(new Set());
  };

  const bulkUpdateSubcategory = (subcategory) => {
    if (!subcategory) return;
    const timestamp = new Date().toISOString();
    Array.from(selectedItems).forEach(id => saveIngredientEdit(id, { subcategory }));
    setIngredients(prev => prev.map(ing => selectedItems.has(ing.id) ? { ...ing, subcategory, lastUpdated: timestamp } : ing));
    setSelectedItems(new Set());
  };

  const bulkUpdateVendor = (vendor) => {
    if (!vendor) return;
    const timestamp = new Date().toISOString();
    Array.from(selectedItems).forEach(id => saveIngredientEdit(id, { vendor }));
    setIngredients(prev => prev.map(ing => selectedItems.has(ing.id) ? { ...ing, vendor, lastUpdated: timestamp } : ing));
    setSelectedItems(new Set());
  };

  const bulkUpdateUnit = (unit) => {
    if (!unit) return;
    const timestamp = new Date().toISOString();
    Array.from(selectedItems).forEach(id => saveIngredientEdit(id, { unit }));
    setIngredients(prev => prev.map(ing => selectedItems.has(ing.id) ? { ...ing, unit, lastUpdated: timestamp } : ing));
    setSelectedItems(new Set());
  };

  const getSelectedItemsCategory = () => {
    if (selectedItems.size === 0) return null;
    const cats = [...new Set(ingredients.filter(i => selectedItems.has(i.id)).map(i => i.category))];
    return cats.length === 1 ? cats[0] : null;
  };

  const selectedCategory = getSelectedItemsCategory();

  const handleSort = (column) => {
    if (sortColumn === column) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortColumn(column);
      setSortDirection('asc');
    }
  };

  const getSortValue = (ing, column) => {
    switch (column) {
      case 'name': return ing.name || '';
      case 'category': return ing.category || '';
      case 'subcategory': return ing.subcategory || 'Other';
      case 'unit': return ing.unit || '';
      case 'vendor': return ing.vendor || 'Sysco';
      case 'vendorCode': return ing.vendorCode || ing.syscoCode || '';
      case 'packSize': return ing.packSize || ing.syscoPackSize || '';
      case 'casePrice': return ing.casePrice || ing.syscoPrice || 0;
      case 'lastUpdated': return ing.lastUpdated || '';
      default: return '';
    }
  };

  const filteredIngredients = ingredients.filter(ing => {
    const matchesSearch = ing.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                          (ing.vendorCode || ing.syscoCode || '').toLowerCase().includes(searchTerm.toLowerCase());
    const matchesCategory = !filterCategory || ing.category === filterCategory;
    const matchesVendor = !filterVendor || ing.vendor === filterVendor;
    return matchesSearch && matchesCategory && matchesVendor;
  }).sort((a, b) => {
    const aVal = getSortValue(a, sortColumn);
    const bVal = getSortValue(b, sortColumn);
    let comparison = typeof aVal === 'number' && typeof bVal === 'number' ? aVal - bVal : String(aVal).localeCompare(String(bVal));
    return sortDirection === 'asc' ? comparison : -comparison;
  });

  const SortHeader = ({ column, label, align }) => {
    const isActive = sortColumn === column;
    const textAlign = align === 'left' ? 'text-left' : align === 'right' ? 'text-right' : 'text-center';
    const flexJustify = align === 'left' ? 'justify-start' : align === 'right' ? 'justify-end' : 'justify-center';
    return (
      <th className={`p-3 border cursor-pointer hover:bg-gray-200 select-none ${textAlign}`} onClick={() => handleSort(column)}>
        <div className={`flex items-center gap-1 ${flexJustify}`}>
          <span>{label}</span>
          <span className={`text-xs ${isActive ? 'text-blue-600' : 'text-gray-400'}`}>
            {isActive ? (sortDirection === 'asc' ? 'â–²' : 'â–¼') : 'â‡…'}
          </span>
        </div>
      </th>
    );
  };

  const allInViewSelected = filteredIngredients.length > 0 && filteredIngredients.every(i => selectedItems.has(i.id));

  return (
    <div className="p-6 max-w-7xl mx-auto">
      <div className="bg-white rounded-lg shadow-lg p-6">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-3xl font-bold text-gray-800">Ingredient Management</h1>
          <div className="flex gap-2">
            <input
              type="file"
              ref={fileInputRef}
              onChange={handleFileSelect}
              accept=".csv"
              className="hidden"
            />
            <button onClick={handleImportClick} className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
              Import Sysco CSV
            </button>
            <button onClick={exportIngredients} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Export CSV</button>
            <button onClick={() => setShowAddForm(!showAddForm)} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
              {showAddForm ? 'âœ• Cancel' : '+ Add Ingredient'}
            </button>
          </div>
        </div>

        {showAddForm && (
          <div className="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
            <h3 className="font-bold text-lg mb-4">Add New Ingredient</h3>
            <div className="grid grid-cols-4 gap-4 mb-4">
              <div className="col-span-2">
                <label className="block text-sm font-medium mb-1">Name *</label>
                <input type="text" value={newIngredient.name} onChange={(e) => setNewIngredient({...newIngredient, name: e.target.value})} className="w-full px-3 py-2 border rounded" placeholder="Ingredient name" />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Category</label>
                <select value={newIngredient.category} onChange={(e) => setNewIngredient({...newIngredient, category: e.target.value, subcategory: categoryStructure[e.target.value]?.[0] || 'Other'})} className="w-full px-3 py-2 border rounded">
                  {categories.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Subcategory</label>
                <select value={newIngredient.subcategory} onChange={(e) => setNewIngredient({...newIngredient, subcategory: e.target.value})} className="w-full px-3 py-2 border rounded">
                  {(categoryStructure[newIngredient.category] || ['Other']).map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
            </div>
            <div className="grid grid-cols-5 gap-4 mb-4">
              <div>
                <label className="block text-sm font-medium mb-1">Unit</label>
                <select value={newIngredient.unit} onChange={(e) => setNewIngredient({...newIngredient, unit: e.target.value})} className="w-full px-3 py-2 border rounded">
                  {units.map(u => <option key={u} value={u}>{u}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Vendor</label>
                <select value={newIngredient.vendor} onChange={(e) => setNewIngredient({...newIngredient, vendor: e.target.value})} className="w-full px-3 py-2 border rounded">
                  {vendors.map(v => <option key={v} value={v}>{v}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Vendor Code</label>
                <input type="text" value={newIngredient.vendorCode} onChange={(e) => setNewIngredient({...newIngredient, vendorCode: e.target.value})} className="w-full px-3 py-2 border rounded" placeholder="Item #" />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Pack Size</label>
                <input type="text" value={newIngredient.packSize} onChange={(e) => setNewIngredient({...newIngredient, packSize: e.target.value})} className="w-full px-3 py-2 border rounded" placeholder="e.g., 50LB" />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Case Price ($)</label>
                <input type="number" step="0.01" value={newIngredient.casePrice} onChange={(e) => setNewIngredient({...newIngredient, casePrice: parseFloat(e.target.value) || 0})} className="w-full px-3 py-2 border rounded" />
              </div>
            </div>
            <div className="flex justify-end">
              <button onClick={handleAddIngredient} className="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">Add Ingredient</button>
            </div>
          </div>
        )}

        <div className="mb-6 grid grid-cols-4 gap-4">
          <div className="col-span-2">
            <label className="block text-sm font-medium text-gray-700 mb-2">Search</label>
            <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search by name or vendor code..." className="w-full px-4 py-2 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
            <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">All Categories</option>
              {categories.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Vendor</label>
            <select value={filterVendor} onChange={(e) => setFilterVendor(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">All Vendors</option>
              {vendors.map(v => <option key={v} value={v}>{v}</option>)}
            </select>
          </div>
        </div>

        <div className="mb-4 flex justify-between items-center">
          <div className="text-sm text-gray-600">
            Showing {filteredIngredients.length} of {ingredients.length} ingredients
            {selectedItems.size > 0 && <span className="ml-2 text-green-600 font-medium">â€¢ {selectedItems.size} selected</span>}
          </div>
          <div className="flex gap-2">
            <button onClick={selectAll} className="px-3 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200">Select All ({filteredIngredients.length})</button>
            {selectedItems.size > 0 && <button onClick={selectNone} className="px-3 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200">Clear Selection</button>}
          </div>
        </div>

        {selectedItems.size > 0 && (
          <div className="mb-4 p-3 bg-green-50 rounded-lg border border-green-300 sticky top-0 z-10">
            <div className="flex flex-wrap items-center gap-3 text-sm">
              <span className="font-bold text-green-800">âœ“ {selectedItems.size} selected</span>
              <span className="text-gray-400">|</span>
              <select onChange={(e) => { bulkUpdateCategory(e.target.value); e.target.value = ''; }} className="px-2 py-1 border rounded text-xs">
                <option value="">Set Category...</option>
                {categories.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
              {selectedCategory && (
                <select onChange={(e) => { bulkUpdateSubcategory(e.target.value); e.target.value = ''; }} className="px-2 py-1 border rounded text-xs bg-yellow-50">
                  <option value="">Set Subcategory ({selectedCategory})...</option>
                  {(categoryStructure[selectedCategory] || ['Other']).map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              )}
              <select onChange={(e) => { bulkUpdateVendor(e.target.value); e.target.value = ''; }} className="px-2 py-1 border rounded text-xs">
                <option value="">Set Vendor...</option>
                {vendors.map(v => <option key={v} value={v}>{v}</option>)}
              </select>
              <select onChange={(e) => { bulkUpdateUnit(e.target.value); e.target.value = ''; }} className="px-2 py-1 border rounded text-xs">
                <option value="">Set Unit...</option>
                {units.map(u => <option key={u} value={u}>{u}</option>)}
              </select>
              <span className="text-gray-400">|</span>
              <button onClick={selectNone} className="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-xs">Clear</button>
            </div>
          </div>
        )}

        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 border w-10">
                  <button onClick={selectAllInView} className={'w-5 h-5 rounded border flex items-center justify-center text-xs mx-auto ' + (allInViewSelected ? 'bg-green-500 text-white border-green-600' : 'bg-white border-gray-400 hover:bg-gray-100')}>
                    {allInViewSelected ? 'âœ“' : ''}
                  </button>
                </th>
                <SortHeader column="name" label="Name" align="left" />
                <SortHeader column="category" label="Category" align="left" />
                <SortHeader column="subcategory" label="Subcategory" align="left" />
                <SortHeader column="unit" label="Unit" align="center" />
                <SortHeader column="vendor" label="Vendor" align="left" />
                <SortHeader column="vendorCode" label="Vendor Code" align="center" />
                <SortHeader column="packSize" label="Pack Size" align="center" />
                <SortHeader column="casePrice" label="Case Price" align="right" />
                <th className="p-3 border text-center">Programs</th>
                <SortHeader column="lastUpdated" label="Last Updated" align="center" />
                <th className="p-3 border w-24 text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {filteredIngredients.map((ing, index) => {
                const isSelected = selectedItems.has(ing.id);
                return (
                  <tr key={ing.id} className={`border-t hover:bg-blue-50 ${isSelected ? 'bg-green-100' : index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                    {editingId === ing.id ? (
                      <>
                        <td className="p-2 border text-center">
                          <button onClick={() => toggleSelected(ing.id)} className={'w-5 h-5 rounded border flex items-center justify-center text-xs mx-auto ' + (isSelected ? 'bg-green-500 text-white border-green-600' : 'bg-white border-gray-400')}>{isSelected ? 'âœ“' : ''}</button>
                        </td>
                        <td className="p-2 border"><input type="text" value={editForm.name} onChange={(e) => setEditForm({...editForm, name: e.target.value})} className="w-full px-2 py-1 border rounded" /></td>
                        <td className="p-2 border">
                          <select value={editForm.category} onChange={(e) => setEditForm({...editForm, category: e.target.value, subcategory: categoryStructure[e.target.value]?.[0] || 'Other'})} className="w-full px-2 py-1 border rounded">
                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                          </select>
                        </td>
                        <td className="p-2 border">
                          <select value={editForm.subcategory} onChange={(e) => setEditForm({...editForm, subcategory: e.target.value})} className="w-full px-2 py-2 border rounded">
                            {(categoryStructure[editForm.category] || ['Other']).map(s => <option key={s} value={s}>{s}</option>)}
                          </select>
                        </td>
                        <td className="p-2 border">
                          <select value={editForm.unit} onChange={(e) => setEditForm({...editForm, unit: e.target.value})} className="w-full px-2 py-1 border rounded">
                            {units.map(u => <option key={u} value={u}>{u}</option>)}
                          </select>
                        </td>
                        <td className="p-2 border">
                          <select value={editForm.vendor || 'Sysco'} onChange={(e) => setEditForm({...editForm, vendor: e.target.value})} className="w-full px-2 py-1 border rounded">
                            {vendors.map(v => <option key={v} value={v}>{v}</option>)}
                          </select>
                        </td>
                        <td className="p-2 border"><input type="text" value={editForm.vendorCode || ''} onChange={(e) => setEditForm({...editForm, vendorCode: e.target.value})} className="w-full px-2 py-1 border rounded text-center" placeholder="Item #" /></td>
                        <td className="p-2 border"><input type="text" value={editForm.packSize || ''} onChange={(e) => setEditForm({...editForm, packSize: e.target.value})} className="w-full px-2 py-1 border rounded text-center" /></td>
                        <td className="p-2 border"><input type="number" step="0.01" value={editForm.casePrice || 0} onChange={(e) => setEditForm({...editForm, casePrice: parseFloat(e.target.value) || 0})} className="w-full px-2 py-1 border rounded text-right" /></td>
                        <td className="p-1 border text-center"><div className="flex flex-col gap-0.5 text-xs">{["Baking & Pastry Arts", "Culinary Arts", "Foodservice"].map(p => (<label key={p} className="flex items-center gap-1 whitespace-nowrap"><input type="checkbox" checked={(editForm.programs || []).includes(p)} onChange={(e) => { const progs = editForm.programs || []; setEditForm({...editForm, programs: e.target.checked ? [...progs, p] : progs.filter(x => x !== p)}); }} className="w-3 h-3" /><span>{p === "Baking \& Pastry Arts" ? "Baking" : p === "Culinary Arts" ? "Culinary" : "Food Svc"}</span></label>))}</div></td>
                        <td className="p-1 border text-center"><div className="flex flex-col gap-0.5 text-xs">{["Baking & Pastry Arts", "Culinary Arts", "Foodservice"].map(p => (<label key={p} className="flex items-center gap-1 whitespace-nowrap"><input type="checkbox" checked={(editForm.programs || []).includes(p)} onChange={(e) => { const progs = editForm.programs || []; setEditForm({...editForm, programs: e.target.checked ? [...progs, p] : progs.filter(x => x !== p)}); }} className="w-3 h-3" /><span>{p === "Baking \& Pastry Arts" ? "Baking" : p === "Culinary Arts" ? "Culinary" : "Food Svc"}</span></label>))}</div></td>
                        <td className="p-2 border text-center text-xs text-gray-500">{formatDate(ing.lastUpdated)}</td>
                        <td className="p-2 border text-center">
                          <button onClick={handleSaveEdit} className="text-green-600 hover:text-green-800 mr-2 text-lg">âœ“</button>
                          <button onClick={handleCancelEdit} className="text-red-600 hover:text-red-800 text-lg">âœ•</button>
                        </td>
                      </>
                    ) : (
                      <>
                        <td className="p-3 border text-center">
                          <button onClick={() => toggleSelected(ing.id)} className={'w-5 h-5 rounded border flex items-center justify-center text-xs mx-auto ' + (isSelected ? 'bg-green-500 text-white border-green-600' : 'bg-white border-gray-400 hover:bg-gray-100')}>{isSelected ? 'âœ“' : ''}</button>
                        </td>
                        <td className={`p-3 border font-medium ${isSelected ? 'text-green-700' : ''}`}>{ing.name}</td>
                        <td className="p-3 border text-sm">{ing.category}</td>
                        <td className="p-3 border text-sm text-gray-600">{ing.subcategory || 'Other'}</td>
                        <td className="p-3 border text-center">{ing.unit}</td>
                        <td className="p-3 border text-sm">{ing.vendor || 'Sysco'}</td>
                        <td className="p-3 border text-center text-sm text-gray-600">{ing.vendorCode || ing.syscoCode || '-'}</td>
                        <td className="p-3 border text-center text-sm">{ing.packSize || ing.syscoPackSize || '-'}</td>
                        <td className="p-3 border text-right">${(ing.casePrice || ing.syscoPrice || 0).toFixed(2)}</td>
                        <td className="p-3 border text-center text-xs text-gray-500">{formatDate(ing.lastUpdated)}</td>
                        <td className="p-3 border text-center text-xs">{(ing.programs || ["Baking \& Pastry Arts", "Culinary Arts", "Foodservice"]).map(p => p === "Baking \& Pastry Arts" ? "B" : p === "Culinary Arts" ? "C" : "F").join(" ")}</td>
                        <td className="p-3 border text-center">
                        <td className="p-3 border text-center text-xs">{(ing.programs || ["Baking \& Pastry Arts", "Culinary Arts", "Foodservice"]).map(p => p === "Baking \& Pastry Arts" ? "B" : p === "Culinary Arts" ? "C" : "F").join(" ")}</td>
                          <button onClick={() => handleEdit(ing)} className="text-blue-600 hover:text-blue-800 mr-2">âœŽ</button>
                          {ing.id?.startsWith('CUSTOM') && <button onClick={() => handleDeleteIngredient(ing.id)} className="text-red-600 hover:text-red-800">ðŸ—‘</button>}
                        </td>
                      </>
                    )}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>

      {/* Import Modal */}
      {showImportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div className="p-4 border-b bg-orange-50">
              <h2 className="text-xl font-bold text-orange-800">Import Sysco Order Guide</h2>
              <p className="text-sm text-orange-600">{importData.length} items found â€¢ {Object.keys(importMatches).length} matched to existing ingredients</p>
            </div>
            
            <div className="p-4 overflow-y-auto max-h-[50vh]">
              <table className="w-full text-sm">
                <thead className="bg-gray-100 sticky top-0">
                  <tr>
                    <th className="p-2 text-left">Sysco Item</th>
                    <th className="p-2 text-left">Code</th>
                    <th className="p-2 text-left">Pack</th>
                    <th className="p-2 text-right">Price</th>
                    <th className="p-2 text-left">â†’ Match To</th>
                    <th className="p-2 text-center">Confidence</th>
                  </tr>
                </thead>
                <tbody>
                  {importData.map((item, idx) => {
                    const match = importMatches[item.syscoCode];
                    return (
                      <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="p-2 font-medium">{item.description}</td>
                        <td className="p-2 text-gray-600">{item.syscoCode}</td>
                        <td className="p-2 text-gray-600">{item.packSize}</td>
                        <td className="p-2 text-right">${item.casePrice.toFixed(2)}</td>
                        <td className="p-2">
                          <select 
                            value={match?.ingredientId || ''} 
                            onChange={(e) => {
                              const ing = ingredients.find(i => i.id === e.target.value);
                              setImportMatches(prev => ({
                                ...prev,
                                [item.syscoCode]: e.target.value ? {
                                  ingredientId: e.target.value,
                                  ingredientName: ing?.name || '',
                                  confidence: 'manual'
                                } : null
                              }));
                            }}
                            className="w-full px-2 py-1 border rounded text-xs"
                          >
                            <option value="">-- Skip --</option>
                            {ingredients.map(ing => (
                              <option key={ing.id} value={ing.id}>{ing.name}</option>
                            ))}
                          </select>
                        </td>
                        <td className="p-2 text-center">
                          {match && (
                            <span className={`px-2 py-1 rounded text-xs ${
                              match.confidence === 'exact' ? 'bg-green-100 text-green-800' :
                              match.confidence === 'high' ? 'bg-blue-100 text-blue-800' :
                              match.confidence === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-gray-100 text-gray-800'
                            }`}>
                              {match.confidence}
                            </span>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            
            <div className="p-4 border-t bg-gray-50 flex justify-between">
              <button 
                onClick={() => { setShowImportModal(false); setImportData([]); setImportMatches({}); }}
                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
              >
                Cancel
              </button>
              <div className="flex gap-2">
                <span className="text-sm text-gray-600 self-center">
                  {Object.values(importMatches).filter(m => m).length} items will be updated
                </span>
                <button 
                  onClick={handleImportApply}
                  className="px-6 py-2 bg-orange-500 text-white rounded hover:bg-orange-600"
                >
                  Apply Updates
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
